{template 'common/header'}
<title>主播申请</title>
<style type="text/css">
    body {margin:0px; background:#efefef; font-family:'微软雅黑'; -moz-appearance:none;}
    .info_main {height:auto;  background:#fff; margin-top:14px; border-bottom:1px solid #e8e8e8; border-top:1px solid #e8e8e8;}
    .info_main .line {margin:0 10px; height:40px; border-bottom:1px solid #e8e8e8; line-height:40px; color:#999;}
    .info_main .line .title {height:40px; width:90px; line-height:40px; color:#444; float:left; font-size:14px;}
    .info_main .line .info { width:100%;float:right;margin-left:-90px; }
    .info_main .line .inner { margin-left:90px; }

    .info_main .line .inner .user_sex {line-height:40px;}
    .info_sub {height:44px; margin:14px 5px; background:#31cd00; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
    .select { border:1px solid #ccc;height:25px;}

    .plus {
        float: left;
        width: 60px;
        height: 60px;
        border: 1px solid #efefef;
        color: #efefef;
        font-size: 45px;
        line-height: 55px;
        text-align: center;
    }
    .preview0,.preview1{
        position: absolute;
        width: 60px;
        height: 60px;
        z-index: 2;
    }
    .preview0 img,.preview1 img {
        width: 100%;
        height: 100%;
    }

    .info_main .line .inner input {
        height: 40px;
        display: block;
        padding: 0px;
        margin: 0px;
        border: 0px;
        float: left;
        font-size: 16px;
    }
</style>

<div id="container">
    <div class="page_topbar">
        <a href="javascript:;" class="back" onclick="history.back()"><i class="iconfont icon-chevron-left"></i></a>
        <div class="title">主播申请</div>
    </div>
    <div class="info_main">
        {if !empty($member['mobile'])}
        <div class="line"><div class="title">手机号码</div><div class='info'><div class='inner'>{$member['mobile']}</div></div></div>
        {else}
        <div class="line"><div class="title">手机号码</div><div class='info'><div class='inner'><input type="text"  id='mobile' placeholder="请输入您的手机号" value=""/></div></div></div>
        {/if}
        {if empty($member['mobile'])}
        <div class="line" style="position: relative"><div class="title">验证码</div><div class='info'><div class='inner'><input type="text" id='code' placeholder="请输入验证码"  value="" /><input id="btnSendCode" style="position: absolute;right: 0;top: 0;" type="button" value="发送验证码"  /></div></div></div>
        {/if}
        <input type="hidden" id="img0" value="" />
        <div class="line"  style="height: 80px;"><div class="title" style="padding-top: 17px;">身份证(正面)</div><div class="info"><div class="inner" style="padding-top: 10px;">
            <div class="plus" style="position:relative;">
                <input type="file" data-tag="0" name='imgFile0' id='imgFile0' style="position:absolute;left:0;z-index:3;width:60px;height:60px;-webkit-tap-highlight-color: transparent;filter:alpha(Opacity=0); opacity: 0;" />
                <i class="fa fa-plus" style="position:absolute;top:10px;right:12px;z-index:1"></i>
                <div id="preview0" class="preview0"></div>
            </div>

        </div></div></div>

        <input type="hidden" id="img1" value="" />
        <div class="line"  style="height: 80px;"><div class="title" style="padding-top: 17px;">身份证(反面)</div><div class="info"><div class="inner" style="padding-top: 10px;">
            <div class="plus" style="position:relative;">
                <input type="file" data-tag="1" name='imgFile1' id='imgFile1' style="position:absolute;left:0;z-index:3;width:60px;height:60px;-webkit-tap-highlight-color: transparent;filter:alpha(Opacity=0); opacity: 0;" />
                <i class="fa fa-plus" style="position:absolute;top:10px;right:12px;z-index:1"></i>
                <div id="preview1" class="preview1"></div>
            </div>

        </div></div></div>

    </div>
    <div class="info_sub">提交</div>
</div>
<script id="member_info" type="text/html">

</script>
<script id="tpl_img" type="text/html">
    <img src='<%url%>' tag="<%tag%>" img='<%filename%>'/>
</script>

<script src="../addons/sz_yi/static/js/dist/ajaxfileupload.js" type="text/javascript"></script>
<script language="javascript">
    require(['tpl', 'core'], function(tpl, core) {
        $('#mobile').blur(function(){
            if(!$('#mobile').isMobile()){
                core.tip.show('请输入正确手机号码!');
                return;
            }
            core.json('member/sendcode', {
                'op'    : 'ismobile',
                'mobile'  : $('#mobile').val(),
            }, function(json) {
                if(json.status==0){
                    core.tip.show(json.result);
                }
            }, true, true);
        });

        var InterValObj; //timer变量，控制时间
        var count = 60; //间隔函数，1秒执行
        var curCount;//当前剩余秒数

        $('#btnSendCode').click(function(){
            if(!$('#mobile').isMobile()){
                core.tip.show('请输入正确手机号码!');
                return;
            }
            curCount = count;

            core.json('member/sendcode', {
                'mobile': $('#mobile').val(),
                'op':'sendcode',
                'anchorFlag':'1'
            }, function(json) {
                if(json.status==1){
                    //设置button效果，开始计时
                    $("#btnSendCode").attr("disabled", "true");
                    $("#btnSendCode").val(curCount + "秒后重新获取验证码");
                    InterValObj = window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
                    //向后台发送处理数据
                }else{
                    core.tip.show(json.result);
                }
            },true,true);
        });
        //timer处理函数
        function SetRemainTime() {
            if (curCount == 0) {
                window.clearInterval(InterValObj);//停止计时器
                $("#btnSendCode").removeAttr("disabled");//启用按钮
                $("#btnSendCode").val("重新发送验证码");
            }
            else {
                curCount--;
                $("#btnSendCode").val("请在" + curCount + "秒内输入验证码");
            }
        }


                $('.info_sub').click(function() {
                    if($(this).attr('saving')=='1')
                    {
                        return;
                    }

                    if($("#img0").val() == '' || $("#img1").val() == ''){
                        core.tip.show('请上传身份证文件');
                        return;
                    }

                    //如果数据库中该用户已经有手机号, 则不用验证手机号
                    {if empty($member['mobile'])}

                    if(!$('#mobile').isMobile()){
                        core.tip.show('请输入正确手机号码!');
                        return;
                    }

                    //检验验证码
                    core.json('member/sendcode', {
                        'code': $('#code').val(),
                        'op':'checkcode'
                    }, function(json) {

                        if(json.status == 0) {
                            core.tip.show(json.result);
                            return;
                        } else {                         
                            $(this).html('正在处理...').attr('saving',1);

                            core.pjson("live/index", {
                                'op': 'post',
                                'memberdata':{
                                    'membermobile': $("#mobile").val(),
                                    'auth_img0': $("#img0").val(),
                                    'auth_img1': $("#img1").val()
                                }
                            }, function(json) {

                                if(json.status==1){
                                    core.tip.show('保存成功');

                                    // location.href="{php echo $this->createMobileUrl('member')}";
                                    window.setTimeout(location.reload(), 2000);
                                }
                                else{
                                    $('.info_sub').html('确认修改').removeAttr('saving');
                                    core.tip.show('保存失败!');
                                }

                            },true,true);
                        }


                    },true,true);

                    {else}

                        core.pjson("live/index", {
                            'op': 'post',
                            'memberdata':{
                                'membermobile': $("#mobile").val(),
                                'auth_img0': $("#img0").val(),
                                'auth_img1': $("#img1").val()
                            }
                        }, function(json) {

                            if(json.status==1){
                                core.tip.show('保存成功');

                                // location.href="{php echo $this->createMobileUrl('member')}";
                                window.setTimeout(location.reload(), 2000);
                            }
                            else{
                                $('.info_sub').html('确认修改').removeAttr('saving');
                                core.tip.show('保存失败!');
                            }

                        },true,true);

                    {/if}


                })
//上传图片
                $('input[type=file]').change(function() {
                    core.loading('正在上传');
                    var tag= $(this).data('tag');
                    $.ajaxFileUpload({
                        url: core.getUrl('util/uploader'),
                        data: {file: "imgFile" + tag},
                        secureuri: false, //异步
                        fileElementId: 'imgFile'+ tag, //上传控件ID
                        dataType: 'json', //返回的数据信息格式
                        success: function(res, status) {
                            core.removeLoading();
                            var obj = $(tpl('tpl_img', res));
                            $('.preview' + tag).html(obj);
                            $('#img' + tag).val( '/attachment/' + res.filename );
                        }, error: function(data, status, e) {
                            core.removeLoading();
                            core.tip.show('上传失败!');
                        }
                    });
                });



    })
</script>

{template 'common/footer'}
