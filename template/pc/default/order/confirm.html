{template 'common/header'}
<title></title>
{template 'common/navigation'}
<!-- 结算订单 -->
<div class="contentorder w m0a">
	<div class="checkout-tit"><span class="tit-txt">填写并核对订单信息</span></div>
	<div class="checkout-steps">
		<div class="step-tit">
             <h3>收货人信息</h3>
             <div class="fr">
                <a href="#" class="ftx-05">新增收货地址</a>
              </div>
        </div>
        <div class="list-address">
        	<div class="user-name item-selected"><span>杨柳</span><b></b></div>
	        <div class="addr-detail">
    	    	<span class="addr-name">{$address['realname']}</span>
        		<span class="addr-info">黑龙江 哈尔滨市 南岗区 城区中兴大道555号东辉明珠园D4栋3单元601</span>
        		<span class="addr-tel">{$address['mobile']}</span>
        		<span class="addr-default">默认地址</span>
        	</div>
        	<div class="choose-div">
        		<a href="#">编辑</a><a href="#">删除</a>
        	</div>
        </div>


        <div class="list-address">
        	<div class="user-name"><span>杨柳</span></div>
	        <div class="addr-detail">
    	    	<span class="addr-name">杨柳</span>
        		<span class="addr-info">黑龙江 哈尔滨市 南岗区 城区中兴大道555号东辉明珠园D4栋3单元601</span>
        		<span class="addr-tel">188****7259</span>
        	</div>
        	<div class="choose-div">
        		<a href="#">编辑</a><a href="#">删除</a>
        	</div>
        </div>

        
        <div class="addr-switch"><a href="#">更多地址<b></b></a></div>
        <div class="hr"></div>


        <div class="step-tit">
             <h3>送货清单</h3>
        </div>
{loop $goods $g}
        <div class="goods-items" data-cartid="{$g['goodsid']}"
              sel='1'
              data-marketprice="{$g['marketprice']}"
              data-goodsid="{$g['goodsid']}"
              data-maxbuy='{$g['maxbuy']}' 
              data-stock='{$g['stock']}'>
        	<div class="p-img">
       			<a href="{php echo $this->createMobileUrl('shop/detail')}&id={$g['goodsid']}"><img src="{$g['thumb']}"></a>
      		</div>
      		<div class="list-name"><a href="{php echo $this->createMobileUrl('shop/detail')}&id={$g['goodsid']}">{$g['title']}</a></div>
      		<div class="cell-pos fl">
  				  <div class="div-add" data-maxbuy="{$g['totalmaxbuy']}" data-stock="{$g['stock']}" data-marketprice="{$g['marketprice']}">
      				<div class="add-pos">-</div>
      				<input type="text" class="num-pos" value="{$g['total']}">
    					<div class="less-pos">+</div>
  				  </div>
		    	</div>
          <div class="list-price fr"><strong class="jd-price" id = "{$g['goodsid']}">{php echo $g['marketprice'] * $g['total']}</strong></div>
        </div>
{/loop}

	</div>
  <div class="order-summary">
    <div class="statistic fr">
        <div class="list">
          <span><em class="ftx-01" id="num">1</em> 件商品，总商品金额：</span>
          <em class="price" id = "priceone"></em>
        </div>
        <div class="list">
          <span>运费：</span>
          <em class="price">￥0.00</em>
        </div>
    </div>
  </div>
  <div class="foot-detail">
    <div class="fc-price-info">
        <span class="price-tit">应付总额：</span>
        <span class="price-numfoot"  id ="pricetwo"></span>
    </div>
    <div class="fc-consignee-info">
      <span class="mr20">寄送至： 黑龙江 哈尔滨市 南岗区 城区  中兴大道555号东辉明珠园D4栋3单元601</span>
       <span>收货人：杨柳 188****7259</span>
    </div>
  </div>
  <div class="inner"><a href="#">提交订单</a></div>
</div>
<!--  -->
<script type="text/javascript">

  $(document).ready(function(){
//顶单
    $('.paysub').click(function() {
        if ($(this).attr('submitting') == '1') {
            return;
        }
        var dispatchid = $("#dispatchid").val();
        var carrierid = $("#carrierid").val();
        var addressid = $("#addressid").val();
        var goods = $("#goods").val();
        var carrier_realname = $.trim( $('#carrier_input_realname').val() );
        var carrier_mobile = $.trim( $('#carrier_input_mobile').val() );
        if (goods == '') {
            core.tip.show("没有任何商品");
            return;
        }
        {if $show==1}
    if( $("#dispatchtype").val()=='0'){
                if (addressid == '') {
        core.tip.show("请选择地址");
        return;
      }
      if (dispatchid == '') {
        core.tip.show("请选择配送方式");
        return;
      }
    } 
            if($('#isverify').val()=='true'){
                if (carrier_realname== '') {
                    core.tip.show("请填写联系人姓名");
                    return;
                }
                if (!$.isMobile(carrier_mobile)) {
                    core.tip.show("请填写正确手机号");
                    return;
                }
            }
            if( $("#dispatchtype").val()=='1'){
                if (carrier_realname== '') {
                    core.tip.show("请填写姓名");
                    return;
                }
                if (!$.isMobile(carrier_mobile)) {
                    core.tip.show("请填写正确手机号");
                    return;
                }
            }
        {/if} 
        var diydata = '';
        var gdid = {php echo intval($goods_data_id)};
        {if !empty($order_formInfo)}
            {template 'diyform/common_js_data'}
        {/if}
        $(this).attr('submitting', '1').html('提交中...');
        var data ={
            'op': 'create', 
            'goods': goods,
    'id':'{$id}',
    gdid:gdid,
    diydata:diydata,
            'dispatchtype': $("#dispatchtype").val(),
            'fromcart':fromcart,
            'cartids':"{$_GPC['cartids']}",
            'remark': $("#remark").val(),
            'deduct':0,
            'deduct2':0
        };
    
        if( $("#dispatchtype").val()=='0'){

            data.addressid = addressid; 
            data.dispatchid = dispatchid;
        }
         
        if( $("#dispatchtype").val()=='1' || $('#isverify').val()=='true'){
            data.carrierid = carrierid;
            data.carrier = {
                'carrier_realname': carrier_realname,
                'carrier_mobile':carrier_mobile,
                'realname': $('#carrier_realname').html(),
                'mobile': $('#carrier_mobile').html(),
                'address': $('#carrier_address').html()
            };
        }
        
        if($("#deductcredit").length>0){
            if($("#deductcredit").attr('on')=='1'){
                  data.deduct = 1;       
            }
        }
         
        if($("#deductcredit2").length>0){
            if($("#deductcredit2").attr('on')=='1'){
                  data.deduct2 = 1;       
            }
        }
        {if $hascouponplugin}
            data.couponid = $('#couponid').val();
        {/if}
        core.json('order/confirm', data, function(create_json) {

            if (create_json.status == 1) {
                location.href = "{php echo $this->createMobileUrl('order/pay')}&orderid=" + create_json.result.orderid +"&openid={$openid}";
            }  else if (create_json.status == -1) {
                 $('.paysub').html('确认订单').removeAttr('submitting');
                 core.tip.show(create_json.result);
            }
            else {
                $('.paysub').html('确认订单').removeAttr('submitting');
                core.tip.show("生成订单失败!")
            }

        }, true, true);
/*    $.post('{php echo $this->createMobileUrl("order/confirm")}',
        {
          op: "tofavorite",
          ids: ids
        },
        function (json){
          if (json.status == 1) {
              $('.item-last[data-cartid='+ moveid +']').attr('sel',0).fadeOut(500,function(){
                $(this).remove();
              });
            calcprice();
          } else {
            alert("移动失败");
          }
        },'json');*/
    })

    function calcprice(){
      var total = 0;
      var totalprice = 0;
      $(".goods-items").each(function(){
        var $this = $(this);
        var num = $this.find(".num-pos").val();
        total+=parseInt(num);
        totalprice+=parseFloat($this.find('.num-pos').val()) * parseFloat($this.attr('data-marketprice'));
        var number=document.getElementById("num");
        number.innerHTML=total;
        var priceone=document.getElementById("priceone");
        priceone.innerHTML="￥" + totalprice;
        var pricetwo=document.getElementById("pricetwo");
        pricetwo.innerHTML="￥" + totalprice;
      });
    }
    $(".add-pos").click(function(){
      var input =$(this).next();
      var num = parseFloat( input.val() );
      num--;
      if(num <= 0){
        num=1;
      }
      input.val(num);
      var cartid = $(this).parent().parent().parent().attr('data-cartid');
      var marketprice = $(this).parent().parent().parent().attr('data-marketprice');
      var singlemon = document.getElementById(cartid);
      var single = input.val() * marketprice;
      singlemon.innerHTML = '￥' + single;
      calcprice();
    });
    $(".less-pos").click(function(){
      var maxbuy = $(this).parent().attr('data-maxbuy');
      var stock = $(this).parent().attr('data-stock');
      var input =$(this).prev();
      var num = parseFloat( input.val() );
      num++;
      if(num >= maxbuy && maxbuy > 0){
        num = maxbuy;
        alert("您最多购买 " + maxbuy + "件");
      } else if(stock!='-1' && stock!='' && num>stock){
        num=stock;
      alert("您最多购买 " + stock + "件");
      }
      input.val(num);
      var cartid = $(this).parent().parent().parent().attr('data-cartid');
      var marketprice = $(this).parent().parent().parent().attr('data-marketprice');
      var singlemon = document.getElementById(cartid);
      var single = input.val() * marketprice;
      singlemon.innerHTML = '￥' + single;
      calcprice();
    });
    calcprice();
  });
</script>
<!-- foot -->
<div class="cover-page-foot fl wfs">
<p class="subnav">
<a target="_blank" href="http://about.ecmoban.com/company.php#contact">联系我们</a>
<a target="_blank" href="http://about.ecmoban.com/company.php">公司简介</a>
<a target="_blank" href="http://about.ecmoban.com/payment.php">支付方式</a>
<a target="_blank" href="http://about.ecmoban.com/legal.php">法律条款</a>
<a target="_blank" href="http://www.ecmoban.com/daili.php">合作代理</a>
<a target="_blank" href="http://about.ecmoban.com/friendlink.php">友情链接</a>
<a target="_blank" href="http://about.ecmoban.com/hr.php">诚聘英才</a>
<a class="last" target="_blank" href="http://www.ecmoban.com/topic/feature_list/index.html">服务支持</a>
</p>
<p class="copyright">© 2005-2016 ecshop模板堂(ecmoban.com) 版权所有，并保留所有权利。常年法律顾问:<a class="copyright" target="_blank" href="http://about.ecmoban.com/article-1557.html">上海华宏律师事务所</a></p>
<p class="address">上海市普陀区中山北路3553号伸大厦3层</p>
<div style="background-color:#E1E1E1; text-align:center; height:20px;padding-top:5px;">
<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010702001054" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="http://www.ecmoban.com/content/themes/ecmoban2014/images/beian_ghs.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">沪公网安备 31010702001054号</p></a>
<div>
</div>
<!--  -->

</body>

</html>
