﻿{template 'web/_header'}
<div class="w1200 ">


<script type="text/javascript" src="resource/js/lib/jquery-ui-1.10.3.min.js"></script>
<link rel="stylesheet" type="text/css" href="../addons/sz_yi/static/css/font-awesome.min.css">

	<div class=" rightlist">

		<div class="right-addbox"><!-- 此处是右侧内容新包一层div -->

			<div class="panel panel-info">
				<div class="panel-body">
					<form action="./index.php" method="get" class="form-horizontal" role="form">
						<input type="hidden" name="c" value="site" />
						<input type="hidden" name="a" value="entry" />
						<input type="hidden" name="m" value="sz_yi" />
						<input type="hidden" name="do" value="shop" />
						<input type="hidden" name="p"  value="goods" />
						<input type="hidden" name="op" value="display" />
						<div class="form-group">
							<label class="col-xs-12 col-sm-2 col-md-2 col-lg-2 control-label">关键字</label>
							<div class="col-xs-12 col-sm-8 col-lg-9">
								<input class="form-control" name="keyword" id="keyword" type="text" value="{if isset($request['keyword'])}{$request['keyword']}{else}商品名称／商品编码{/if}" onclick="value='';" ／>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-2 col-md-2 col-lg-2 control-label">状态</label>
							<div class="col-xs-12 col-sm-8 col-lg-9">
								<select name="status" class='form-control'>
									<option value="" ></option>
									<option value="1" >{$lang['putaway']}</option>
									<option value="0" >{$lang['soldout']}</option>
								</select>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-2 col-md-2 col-lg-2 control-label">商品类型</label>

							<div class="col-xs-12 col-sm-8 col-lg-9">
								{loop $product_attr_list $product_attr_key
								$product_attr_name}
								<label for="{$product_attr_key}" style="font-weight:100; margin-left:10px;">
									<input type="checkbox"  {if @in_array($product_attr_key, $product_attr)} checked="checked"{/if} name="product_attr[]"
									value="{$product_attr_key}" id="{$product_attr_key}" />
									{$product_attr_name}
								</label>
								{/loop}
							</div>
						</div>


						<div class="form-group">
							<label class="col-xs-12 col-sm-2 col-md-2 col-lg-2 control-label">分类</label>

							{if $shopset['category2'] != 1}
							<div class="col-xs-12 col-sm-2 col-lg-2">
								<button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
							</div>
							{/if}
						</div>
						{if $shopset['category2'] == 1}
						<div class="form-group">
							<label class="col-xs-12 col-sm-2 col-md-2 col-lg-2 control-label">{$shopset['category2name']}分类</label>
							<div class="col-sm-8 col-xs-12">

							</div>
							<div class="col-xs-12 col-sm-2 col-lg-2">
								<button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
							</div>
						</div>
						{/if}

					</form>
				</div>
			</div>

			<style type="text/css">
				.label{cursor:pointer;}

				.umphp {
					position: relative;
				}

				.img {

					display: none;
					position: absolute;
					top: -55px;
					right: 44px;
					border: 1px solid #d0aaaa;
					border-radius: 15px;
					background: #FFF;
					padding: 10px;margin-left: 10px;
				}

				.selected .img {
					display: block;
				}

				.triangle-left {
					position: absolute;right: -10px;top:57px;z-index: 999;
					border-color: #ededed transparent transparent transparent;
					width: 0;
					height: 0;
					border-top: 10px solid transparent;
					border-bottom: 10px solid transparent;
					border-left: 10px solid #e7eaec;
				}
			</style>
			<form action="" method="post">
				<div class="panel panel-default">
					<div class="panel-body table-responsive">
						<table class="table table-hover">
							<thead class="navbar-inner">
							<tr>
								<th width="6%">ID</th>
								<th width="6%">排序</th>
								<th width="6%">{$lang['good']}</th>
								<th width="26%">&nbsp;</th>
								<th width="16%">{$lang['price']}<br/>{$lang['repertory']}</th>

								<th width="10%">销量</th>
								<th width="10%">状态</th>

								<th width="20%">操作</th>
							</tr>
							</thead>
							<tbody>
							{loop $list $item}
							<tr>

								<td width="6%">{$item['id']}</td>
								<td width="6%">
									{ifp 'shop.goods.edit'}
									<input type="text" class="form-control" name="displayorder[{$item['id']}]" value="{$item['display_order']}">
									{else}
									{$item['displayorder']}
									{/if}
								</td>
								<td width="6%" title="{$item['title']}">
									<img src="{php echo tomedia($item['thumb'])}" style="width:40px;height:40px;padding:1px;border:1px solid #ccc;"  />
								</td>
								<td title="{$item['title']}" class='tdedit' width="26%">


									{ifp 'shop.goods.edit'}
									<span class=' fa-edit-item' style='cursor:pointer'><i class='fa fa-pencil' style="display:none"></i> <span class="title">{$item['title']}</span> </span>
									<div class="input-group goodstitle" style="display:none" data-goodsid="{$item['id']}">
										<input type='text' class='form-control' value="{$item['title']}"   />
										<div class="input-group-btn">
											<button type="button" class="btn btn-default" data-goodsid='{$item['id']}' data-type="title"><i class="fa fa-check"></i></button>
										</div>
									</div>
									{else}
									{$item['title']}
									{/if}
								</td>
								<td class='tdedit' width="16%">
										{if $item['has_option']==1}
											{ifp 'shop.goods.edit'}
											<span class='tip' title='多规格不支持快速修改'>{$item['market_price']}</span>
											{else}
											{$item['market_price']}
											{/if}
										{else}
											{ifp 'shop.goods.edit'}

											<span class=' fa-edit-item' style='cursor:pointer'><i class='fa fa-pencil' style="display:none"></i> <span class="title">{$item['market_price']}</span> </span>
											<div class="input-group" style="display:none" data-goodsid="{$item['id']}">
												<input type='text' class='form-control' value="{$item['market_price']}"   />
												<div class="input-group-btn">
													<button type="button" class="btn btn-default" data-goodsid='{$item['id']}' data-type="marketprice"><i class="fa fa-check"></i></button>
												</div>
											</div>
											{else}
											{$item['marketprice']}
											{/if}
										{/if}
										<br/>
										{if $item['has_option']==1}
											{ifp 'shop.goods.edit'}
											<span class='tip' title='多规格不支持快速修改'>{$item['stock']}</span>
											{else}
											{$item['stock']}
											{/if}
										{else}
											<span class=' fa-edit-item' style='cursor:pointer'><i class='fa fa-pencil' style="display:none"></i> <span class="title">{$item['stock']}</span> </span>
											<div class="input-group" style="display:none" data-goodsid="{$item['id']}">
												<input type='text' class='form-control' value="{$item['stock']}"   />
												<div class="input-group-btn">
													<button type="button" class="btn btn-default" data-goodsid='{$item['id']}' data-type="total"><i class="fa fa-check"></i></button>
												</div>
											</div>
										{/if}


								</td>

								<td >{$item['real_sales']}</td>
								<td >

									{if p('supplier')}
										{if $var['isfounder'] == 1}
											<label data='{$item['status']}' class='label  label-default {if $item['status']==1}label-info{/if}' {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'status')"{/if}>{if $item['status']==1}{$lang['putaway']}{else}{$lang['soldout']}{/if}</label>
										{else}
											<?php $roleid = pdo_fetchcolumn('select id from' . tablename('sz_yi_perm_role') . ' where status1=1')?>
											<?php $userroleid = pdo_fetchcolumn('select roleid from' . tablename('sz_yi_perm_user') . ' where uid=' . $_W['uid'])?>
											{if $roleid == $userroleid}
											<label data='{$item['status']}' class='label  label-default {if $item['status']==1}label-info{/if}' >
											{else}
											<label data='{$item['status']}' class='label  label-default {if $item['status']==1}label-info{/if}' {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'status')"{/if}>
											{/if}
											{if $item['status']==1}{$lang['putaway']}{else}{$lang['soldout']}{/if}
											</label>
											{/if}
									{else}
									<label data='{$item['status']}' class='label  label-default {if $item['status']==1}label-info{/if}' {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'status')"{/if}>{if $item['status']==1}上架{else}下架{/if}</label>
									{/if}

								</td>

								<td style="position:relative; overflow:visible;" width="20%">
									<!-- yitian_add::商品链接二维码 2017-02-07 qq:751818588 -->
									<a class="btn btn-sm btn-default umphp" title="商品二维码" data-url="{php echo $this->createMobileUrl('shop/detail', array('id' => $item['id']));}" data-goodsid = "{$item['id']}">
										<div class="img">
											<img id="{$item['id']}" src="" style="width:110px;">
											<div class="arrow-bottom"></div>
											<div class="triangle-left"></div>
										</div>
										<i class="fa fa-qrcode"></i>
									</a>

									<a href="{php echo $this->createWebUrl('shop/goods', array('id' => $item['id'] ,'op' =>'copygoods'))}"  title="{$lang['copyshop']}" class="btn btn-default btn-smjs-clip" style="font-size: 13px;"><i class="fa fa-article"></i></a>
									{ifp 'shop.goods.edit|shop.goods.view'}<a href="{php echo $this->createWebUrl('goods.goods.edit', array('id' => $item['id']))}"class="btn btn-sm btn-default" title="{ifp 'shop.goods.edit'}编辑{else}查看{/if}" target="_blank"><i class="fa fa-edit"></i></a>{/if}
									{ifp 'shop.goods.delete'}<a href="{php echo $this->createWebUrl('shop/goods', array('id' => $item['id'], 'op' => 'delete'))}" onclick="return confirm('确认删除此商品？');
										return false;" class="btn btn-default  btn-sm" title="删除"><i class="fa fa-trash"></i></a>{/if}
									<a href="javascript:;" data-url="{php echo $this->createMobileUrl('shop/detail', array('id' => $item['id']));}"  title="复制连接" class="btn btn-default btn-sm js-clip"><i class="fa fa-link"></i></a>
								</td>
							</tr>
							<tr>
								<td  colspan="10" style="text-align: right;padding: 6px 30px;border-top:none;">

									{if $item['goods_sn']}
									<label data='{$item['isnew']}' class='label label-default text-default'>商品编号：</label><span style="font-size:14px;color:#7B7B7B; margin-right:20px;">{$item['goods_sn']}</span>
									{/if}
									<label data='{$item['is_new']}' class='label label-default text-default {if $item['is_new']==1}label-info text-pinfo{else}{/if}'   {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'new')"{/if}>新品</label>-

									<label data='{$item['is_hot']}' class='label label-default text-default {if $item['is_hot']==1}label-info text-pinfo{/if}' {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'hot')"{/if}>热卖</label>-

									<label data='{$item['is_recommand']}' class='label label-default text-default {if $item['is_recommand']==1}label-info text-pinfo{/if}' {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'recommand')"{/if}>推荐</label>-

									<label data='{$item['is_discount']}' class='label label-default text-default {if $item['is_discount']==1}label-info text-pinfo{/if}' {ifp 'shop.goods.edit'}onclick="setProperty(this,{$item['id']},'discount')"{/if}>促销</label>-


								</td>
							</tr>
							{/loop}
							<tr>
								<td colspan='10'>
									{ifp 'shop.goods.add'}
									<a class='btn btn-primary' href="{php echo $this->createWebUrl('goods.goods.create')}"><i class='fa fa-plus'></i> 发布{$lang['good']}</a>
									{/if}
									{ifp 'shop.goods.edit'}
									<input name="submit" type="submit" class="btn btn-default" value="提交排序">
									<input type="hidden" name="token" value="{$var['token']}" />
									{/if}

								</td>
							</tr>

							</tr>
							</tbody>
						</table>
						{$pager}
						<!--分页-->
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
</div>

<script type="text/javascript">
	//鼠标划过显示商品链接二维码
    $('.umphp').hover(function() {
        var url = $(this).attr('data-url');
        var goodsid = $(this).attr('data-goodsid');
		$.post("{php echo $this->createWebUrl('shop/goods')}"
			, {'op': 'goods_qrcode', id: goodsid, url: url}
			, function (qr) {
                if (qr.img) {
					var goodsqr = qr.img;
                    var element = document.getElementById(goodsid);
                    element.src = goodsqr;
                }
			}
			, "json"
		);
		$(this).addClass("selected");
	},
	function() {
		$(this).removeClass("selected");
	})
	function fastChange(id, type, value) {
		$.ajax({
			url: "{php echo $this->createWebUrl('shop/goods')}",
			type: "post",
			data: {op: 'change', id: id, type: type, value: value},
			cache: false,
			success: function () {
				location.reload();
			}
		})
	}
	$(function () {
		$("form").keypress(function(e) {
			if (e.which == 13) {
			  return false;
			}
		  });

		$('.tdedit input').keydown(function (event) {
			if (event.keyCode == 13) {
			     var group = $(this).closest('.input-group');
				 var type = group.find('button').data('type');
				var goodsid = group.find('button').data('goodsid');
				var val = $.trim($(this).val());
				if(type=='title' && val==''){
					return;
				}
				group.prev().show().find('span').html(val);
				group.hide();
				fastChange(goodsid,type,val);
			}
		})
		$('.tdedit').mouseover(function () {
			$(this).find('.fa-pencil').show();
		}).mouseout(function () {
			$(this).find('.fa-pencil').hide();
		});
		$('.fa-edit-item').click(function () {
			var group = $(this).closest('span').hide().next();

			group.show().find('button').unbind('click').click(function () {
				var type = $(this).data('type');
				var goodsid = $(this).data('goodsid');
				var val = $.trim(group.find(':input').val());
				if(type=='title' && val==''){
					Tip.show(group.find(':input'), '请输入名称!');
					return;
				}
				group.prev().show().find('span').html(val);
				group.hide();
				fastChange(goodsid,type,val);
			});
		})
	})
	function setProperty(obj, id, type) {
		$(obj).html($(obj).html() + "...");
		$.post("{php echo $this->createWebUrl('shop/goods')}"
				, {'op': 'setgoodsproperty', id: id, type: type, plugin: "", data: obj.getAttribute("data")}
		, function (d) {
			$(obj).html($(obj).html().replace("...", ""));
			if (type == 'type') {
				$(obj).html(d.data == '1' ? '实体物品' : '虚拟物品');
			}
			if (type == 'status') {
				$(obj).html(d.data == '1' ? '{$lang['putaway']}' : '{$lang['soldout']}');
			}
			$(obj).attr("data", d.data);
			if (d.result == 1) {
				$(obj).toggleClass("label-info text-pinfo");
			}
		}
		, "json"
				);
	}

</script>

{template 'web/_footer'}