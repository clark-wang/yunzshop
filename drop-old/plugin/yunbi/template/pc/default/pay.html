{template 'member/center'}
<title>购买{$yunbi_title}支付</title>
<style type="text/css">
    body {margin:0px; background:#efefef; font-family:'微软雅黑'; -moz-appearance:none;}
.order_main {height:auto; border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; background:#fff;margin-top:10px;}
.order_main .line {height:44px; margin:0 5px; border-bottom:1px solid #f0f0f0; line-height:44px;}
.order_main .line .label1 { float:left;width:80px;}
.order_main .line .info { float:right; width:100%; margin-left:-85px;text-align: right;overflow:hidden;height:44px;}
.order_main .line .info .inner { color:#666;margin-left:85px;}
.order_main .tip { color:#666; line-height:20px;padding:5px;font-size:13px; }
 
  .order_main .line .nav {height:22px; width:40px; background:#ccc; margin:10px 0px; float:right; border-radius:40px;}
.order_main .line .on {background:#4ad966;}
.order_main .line .nav nav {height:20px; width:20px; background:#fff; margin:1px; border-radius:20px;}
.order_main .line .nav .on {margin-left:19px;}

.order_sub1 {height:44px; margin:14px 5px; background:#31cd00; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
.order_sub10 {height:44px; margin:14px 5px; background:#31cd00; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
.order_sub2 {height:44px; margin:14px 5px; background:#f49c06; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
.order_sub3 {height:44px; margin:14px 5px;background:#e2cb04; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
.order_sub4 {height:44px; margin:14px 5px; background:#18c0f7; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}

.order_main1 {height:30px;padding:10px;border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; background:#fff;text-align:center;margin-top:10px; }
.order_sub5 {height:30px; width:35%;padding:5px 10px 5px 10px; border:1px solid #ccc; border-radius:4px; text-align:center; font-size:16px; line-height:30px; color:#333; }
.order_sub6 {height:44px; margin:14px 5px; background:#07c4d0; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}

.order_sub7 {height:44px; margin:14px 5px; background:#07c4d0; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
.order_subc {height:44px; margin:14px 5px; background:#31cd00; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
</style>

<div id='container' class="rightlist"></div>
<script id='tpl_order_info' type='text/html'>
    <input type='hidden' id='id' value="<%trading.id%>"/>
       <div class="page_topbar">
        <div class="title">购买{$yunbi_title}支付</div>
    </div>
    <div class="order_main" >  
        <div class="line"><div class="label1">{$yunbi_title}编号</div><div class="info"><div class="inner"><%trading.id%></div></div></div>
        <div class="line"><div class="label1">支付金额</div><div class="info"><div class="inner"><div style='color:#ff6600'>￥<span id="orderprice" price="<%trading.price%>"><%trading.price%></span>元</div></div></div></div>
    </div>
    <%if trading.price>0%>    
        <%if credit.success %>
            <div class="button order_sub3">{if $shopset['credit']}{$shopset['credit']}{else}余额{/if}支付(当前{if $shopset['credit']}{$shopset['credit']}{else}余额{/if}:<%credit.current%>)</div>
            <input type="hidden" id="credit" value="<%credit.current%>" />
            <%if credit.current<=0%>
                <div class="button order_sub4" onclick="location.href='{php echo $this->createMobileUrl('member/recharge')}&returnurl=<%returnurl%>'">账户充值</div>
            <%/if%>  
        <%/if%>
    <%/if%>

</script>

<script id='tpl_order_pay' type='text/html'>
    <div class="page_topbar">
        <div class="title">支付成功</div>
    </div>
    <img src="../addons/sz_yi/template/mobile/default/static/images/pay_virtual.png" style="width:100%;" />
     <div class="order_main1" >
         <span class="order_sub5" onclick="location.href='{php echo $this->createPluginMobileUrl('yunbi/yunbi_log')}'">查看详情</span>   
         <span class="order_sub5" onclick="location.href='{php echo $this->createMobileUrl('shop')}'">返回首页</span>
     </div>
</script>

 

<script language="javascript">
    require(['tpl', 'core'], function(tpl, core) {
        core.pjson('yunbi/yunbi_trading',{id:'{$_GPC['id']}','op':'buy'},function(json){
            var result = json.result;
            // if(json.status==-1){
            //      location.href = core.getUrl('order/detail',{id:"{$_GPC['orderid']}"});
            //      return;
            // }
            if(json.status!=1){
                 core.message(result,"{php echo $this->createPluginMobileUrl('yunbi/yunbi_trading')}",'error');
                 return;
            }

            $('#container').html(tpl('tpl_order_info',result));
            
           
           
           if(result.credit.success){
               $(".order_sub3").click(function(){
                 if($(this).attr('submitting')=='1'){
                     return;
                 }
                 core.tip.confirm('确认要立即付款?',function(){
                    $('.button').attr('submitting',1);
                    core.pjson('yunbi/yunbi_trading',{
                        op:'complete',
                        id:'{$_GPC['id']}',
                        type:'credit'
                    },function(pay_json){
                        if(pay_json.status==1){
                           $('#container').html(tpl('tpl_order_pay'));
                           return;
                        }
                        core.tip.show(pay_json.result);
                        $('.button').removeAttr('submitting');
                    },true,true);
               });
                });
           }

             
        
    },true)
});
 
</script>
{template 'common/footer'}
