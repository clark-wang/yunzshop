{template 'common/header'}
<title>{if empty($set['title'])}众筹列表{else}{$set['title']}{/if}</title>
<link href="../addons/sz_yi/plugin/fund/template/mobile/default/static/css/zc.css" rel="stylesheet" type="text/css">
<link href="../addons/sz_yi/plugin/fund/template/mobile/default/static/font/iconfont.css" rel="stylesheet" type="text/css">
<div id='container'></div>

<script id='tpl_main' type='text/html'>
    <div class="main">
        
        <div class='page'>
            <!--商品列表-->
            <div class="goods">
                <div id='goods_container'></div>
            </div>
        </div>
        
    </div>
</script>
 
<script id='tpl_goods_list' type='text/html'>
    {loop $goods $g}
    <div class="zc-card project" data-goodsid='{$g['id']}'>
        <div class="card_top">{$g['title']}</div>
        <div class="card_con">
            <span class="status_com">众筹中</span>
            <a href="javascript:void(0)" style="width:100%"><img src="{$g['thumb']}"></a>
        </div>
        <div class="card_foot">
            <div class="jine">筹集金额<em>￥</em><span> {$g['yetprice']} </span>元/<em>￥</em><span> {$g['allprice']} </span>元</div>
            <ul>
                <li>支持人数<br><span>{$g['people']}</span></li>
                <li>项目进度<br><span>{$g['percentage']}%</span></li>
                <li>剩余时间<br><span>{$g['sday']['n']}</span>{$g['sday']['text']}</li>
            </ul>
            <div class="progress_container">
               <div class="progress_bar" progress="101" style="width: {php echo $g['percentage'] > 100 ? 100 : $g['percentage'];}%;"></div>
            </div>
            <div class="exp_text">
                <a href="javascript">{$g['desc']}</a>
            </div>
        </div>
    </div>
    {/loop}

    {$pager}
</script>
<script id='tpl_empty' type='text/html'>
 <div class="list_no"><i class="fa fa-shopping-cart" style="font-size:100px;"></i><br><span style="line-height:18px; font-size:16px;">暂时没有相关商品</span><br>主人快去给我找点其他东西吧</div>
<div class="list_no_menu">
        <div class="list_no_nav" onclick="location.href='{php echo $this->createMobileUrl('shop/list')}'">看看其他的</div>
 </div>
</script>
<script language='javascript'>
    var loaded = false;
    var stop = true;
    var category = null;
    var def_args = args  = {
           page:"{$_GPC['page']}",
           isnew: "{$_GPC['isnew']}",
           ishot: "{$_GPC['ishot']}",
           isrecommand:"{$_GPC['isrecommand']}",
           isdiscount:"{$_GPC['isdiscount']}",
           keywords:"{$_GPC['keywords']}",
           istime:"{$_GPC['istime']}",
           pcate:"{$_GPC['pcate']}",
           ccate:"{$_GPC['ccate']}",
           tcate:"{$_GPC['tcate']}",
           order:"{$_GPC['order']}",
           by:"{$_GPC['by']}",
           shopid:"{$_GPC['shopid']}"
    };

    require(['tpl', 'core'], function (tpl, core) {
      function getGoods() {
          core.json('shop/list', args, function (json) {
              $('#goods_container').html(tpl('tpl_goods_list',json.result));
              bindEvents();
            }, true);
      }

    function getGoodsMore() {
 
        core.pjson('fund/list', args, function (json) {
            var result = json.result;
            $('#goods_container').append(tpl('tpl_goods_list',result));
            bindEvents();
            $('#list_loading').remove();
            if (result.goods.length < result.pagesize) {
                    $('#goods_container').append('<div id="list_loading">已经加载全部商品</div>');
                    loaded = true;
                    $(window).scroll = null;
                    return;
            }
            stop=true;
            bindMore(); 
            
        });
    }

    function bindEvents() {

        $('.project').unbind('click').click(function () {
                    location.href = core.getUrl('plugin/fund/detail', {id: $(this).data('goodsid'),my:'{$_GPC['my']}'});
        });
    }
    
    function bindMore() {
 
        $(window).scroll(function () {

            if (loaded) {
                return;
            }
            totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
            if ($(document).height() <= totalheight) {
            
                if (stop == true) {
                    stop = false;
                    $('#goods_container').append('<div id="list_loading"><i class="fa fa-spinner fa-spin"></i> 正在加载更多商品</div>');
              
                    if(args.page=='' || args.page=='undefined'){
                        args.page = 1;
                    }
                    args.page++;
                    getGoodsMore();
                }
            }
        });
    }

    $('#container').html(tpl('tpl_main'));
     getGoods();
        

    });
</script>
{php $show_footer = true;}
{template 'common/footer'}

