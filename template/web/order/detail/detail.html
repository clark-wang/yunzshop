{template 'web/_header'}
<div class="w1200 m0a">
    {template 'web/order/tabs'}
<script type="text/javascript" src="../addons/sz_yi/static/js/dist/area/cascade.js"></script>
    <style type="text/css">
        .main .form-horizontal .form-group{margin-bottom:0;}
        .main .form-horizontal .modal .form-group{margin-bottom:15px;}
        #modal-confirmsend .control-label{margin-top:0;}
        .ad2 {display: none;}
        .ex2  {display: none;}
        .label {white-space: normal;text-align: left;line-height: 16px}
    </style>
    <div class="rightlist">
        <!-- 新增加右侧顶部三级菜单 -->
        <div class="right-titpos">
            <ul class="add-snav">
                <li class="active"><a href="#">订单管理</a></li>
                <li><a href="#">订单详情</a></li>
            </ul>
        </div>
        <!-- 新增加右侧顶部三级菜单结束 -->
        <div class="main">
            <form class="form-horizontal form" action="" method="post">
                {if $item['transid']}<div  class="alert alert-error"><i class="fa fa-lightbulb"></i> 此为微信支付订单，必须要提交发货状态！</div>{/if}
                <input type="hidden" name="id" value="{$item['id']}" />
                <input type="hidden" name="token" value="{$_W['token']}" />
                <input type="hidden" name="dispatchid" value="{$dispatch['id']}" />
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">粉丝 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <img src='{$member['avatar']}' style='width:100px;height:100px;padding:1px;border:1px solid #ccc' />
                                {$member['nickname']}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">会员信息 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <div class='form-control-static'>ID: {$member['id']} 姓名: {$member['realname']} / 手机号: {$member['mobile']} /微信号: {$member['weixin']}</div>
                            </div>
                        </div>

                        {if $item['transid']}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">微信交易号 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">{$item['transid']}</p>
                            </div>
                        </div>
                        {/if}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">订单编号 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">{$item['ordersn_general']} </p>
                            </div>
                        </div>
                        {if $item['pay_ordersn']}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">支付单号 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">{$item['pay_ordersn']} </p>
                            </div>
                        </div>
                        {/if}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">订单金额 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <div class="form-control-static"><table cellspacing="0" cellpadding="0">
                                    <tr>
                                        <td  style='border:none;text-align:right;'>商品小计：</td>
                                        <td  style='border:none;text-align:right;;'>￥{php echo number_format( $item['goodsprice'] ,2)}</td>
                                    </tr>
                                    <tr>
                                        <td  style='border:none;text-align:right;'>运费：</td>
                                        <td  style='border:none;text-align:right;;'>￥{php echo number_format( $item['olddispatchprice'],2)}</td>
                                    </tr>

                                    {if $item['deductyunbimoney']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>{if !empty($yunbiset['yunbi_title'])}{php echo $yunbiset['yunbi_title']}{else}云币{/if}抵扣：</td>
                                        <td  style='border:none;text-align:right;;'>-￥{php echo $item['deductyunbimoney']}</td>
                                    </tr>
                                    {/if}

                                    {if $item['discountprice']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>会员折扣：</td>
                                        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['discountprice'],2)}</td>
                                    </tr>
                                    {/if}

                                    {if $item['deductprice']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>{php echo SZ_YI_INTEGRAL}抵扣：</td>
                                        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['deductprice'],2)}</td>
                                    </tr>
                                    {/if}
                                    {if $item['deductcredit2']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>余额抵扣：</td>
                                        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['deductcredit2'],2)}</td>
                                    </tr>
                                    {/if}
                                    {if $item['deductcommission']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>佣金抵扣：</td>
                                        <td  style='border:none;text-align:right;'>-￥{php echo number_format( $item['deductcommission'],2)}</td>
                                    </tr>
                                    {/if}
                                    {if $item['deductenough']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>满额立减：</td>
                                        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['deductenough'],2)}</td>
                                    </tr>
                                    {/if}
                                    {if $item['couponprice']>0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>优惠券优惠：</td>
                                        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['couponprice'],2)}</td>
                                    </tr>
                                    {/if}
                                    {if intval($item['changeprice'])!=0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>卖家改价：</td>
                                        <td  style='border:none;text-align:right;;'><span style="{if 0<$item['changeprice']}color:green{else}color:red{/if}">{if 0<$item['changeprice']}+{else}-{/if}￥{php echo number_format(abs($item['changeprice']),2)}</span></td>
                                    </tr>
                                    {/if}
                                    {if intval($item['changedispatchprice'])!=0}
                                    <tr>
                                        <td  style='border:none;text-align:right;'>卖家改运费：</td>
                                        <td  style='border:none;text-align:right;;'><span style="{if 0<$item['changedispatchprice']}color:green{else}color:red{/if}">{if 0<$item['changedispatchprice']}+{else}-{/if}￥{php echo abs($item['changedispatchprice'])}</span></td>
                                    </tr>
                                    {/if}
                                    <tr>
                                        <td style='border:none;text-align:right;'>应收款：</td>
                                        <td  style='border:none;text-align:right;color:green;'>￥{php echo number_format($item['price'],2)}</td>
                                    </tr>
                                    {ifp 'order.op.changeprice'}
                                    {if empty($item['statusvalue'])}
                                    <tr>
                                        <td style='border:none;text-align:right;'></td>
                                        <td  style='border:none;text-align:right;color:green;'><a href="javascript:;" class="btn btn-link " onclick="changePrice('{$item['id']}')">修改价格</a></td>
                                    </tr>
                                    {/if}  {/if}
                                </table></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">订单状态 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">
                                    {if $item['status'] == 0}<span class="label label-info">待付款</span>{/if}
                                    {if $item['status'] == 1}<span class="label label-info">待发货</span>{/if}
                                    {if $item['status'] == 2}<span class="label label-info">待收货</span>{/if}
                                    {if $item['status'] == 3}<span class="label label-success">已完成</span>{/if}
                                    {if $item['status'] == -1}
                                    {if !empty($refund) && $refund['status']==1}
                                    <span class="label label-default">已{$r_type[$refund['rtype']]}</span> {if !empty($refund['refundtime'])}完成时间: {php echo date('Y-m-d H:i:s',$refund['refundtime'])}{/if}
                                    {else}
                                    <span class="label label-default">已关闭</span>
                                    {/if}
                                    {/if}
                                </p>
                            </div>
                        </div>
                        {if !empty($refund) && $refund['status']==1}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">退款时间 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <div class="form-control-static">{php echo date('Y-m-d H:i:s',$item['refundtime'])}</div>
                            </div>
                        </div>
                        {/if}

                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">下单日期 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">{php echo date('Y-m-d H:i:s', $item['createtime'])}</p>
                            </div>
                        </div>
                        {if $item['status']>=1}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">付款时间 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">{php echo date('Y-m-d H:i:s', $item['paytime'])}</p>
                            </div>
                        </div>
                        {/if}
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">完成时间 :</label>
                            <div class="col-sm-9 col-xs-12">
                                <p class="form-control-static">{php echo date('Y-m-d H:i:s', $item['finishtime'])}</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">备注 :</label>
                            <div class="col-sm-9 col-xs-12"><textarea style="height:150px;" class="form-control" name="remark" cols="70">{$item['remark']}</textarea></div>
                        </div>

                        <div class="form-group">
                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                            <div class="col-sm-9 col-xs-12">
                                <br/>
                                <button type='submit' name='saveremark' class='btn btn-default'>保存备注</button>
                            </div>
                        </div>
                    </div>
            </form>

            {if !empty($refund)}

            <div class="panel panel-default">
                <div class="panel-heading">
                    退款申请
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">退款类型 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <p class="form-control-static">{$r_type[$refund['rtype']]}</p>
                        </div>
                    </div>

                    {if $refund['rtype']!=2}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">退款金额 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <p class="form-control-static">{$refund['applyprice']}</p>
                        </div>
                    </div>
                    {/if}

                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">{if $refund['rtype']==2}换货{else}退款{/if}原因 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <p class="form-control-static">{$refund['reason']}</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">{if $refund['rtype']==2}换货{else}退款{/if}说明 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <p class="form-control-static">{php echo empty($refund['content'])?'无':$refund['content']}</p>
                        </div>
                    </div>
                    {if !empty($refund['imgs'])}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">图片凭证 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <p class="form-control-static">
                                {loop $refund['imgs'] $k1 $v1}
                                <a target="_blank" href="{php echo tomedia($v1)}"><img style='width:100px;;padding:1px;border:1px solid #ccc'  src="{php echo tomedia($v1)}"></a>
                                {/loop}
                            </p>
                        </div>
                    </div>
                    {/if}
                    {if $refund['status']==1}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">退款时间 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{php echo date('Y-m-d H:i:s',$item['refundtime'])}</div>
                        </div>
                    </div>
                    {/if}

                    {if $item['paytype'] == 26 || $item['paytype'] == 25}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">到账时间 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static" style="color: red">3-15个工作日</div>
                        </div>
                    </div>
                    {/if}

                    {if ($item['paytype'] == 27 || $item['paytype'] == 28) && empty($item['trade_no'])}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">退款操作 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static" style="color: red">请手动退款</div>
                        </div>
                    </div>
                    {/if}

                    {ifp 'order.op.refund'}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                        <div class="col-sm-9 col-xs-12">
                            {if $refund['status']==0 || $refund['status']>=3}
                            <a class="btn btn-danger btn-sm" href="javascript:;" onclick="$('#modal-refund').find(':input[name=id]').val('{$item['id']}')" data-toggle="modal" data-target="#modal-refund">处理{$r_type[$refund['rtype']]}申请</a>
                            {elseif $refund['status']==-1 || $refund['status']==2}
                            <span class='label label-default'>已拒绝</span>
                            {elseif $refund['status']==-2}
                            <span class='label label-default'>客户取消</span>
                            {elseif $refund['status']==1}
                            <span class='label label-danger'>已完成</span>
                            {/if}
                        </div>
                    </div>
                    {/if}

                    {if !empty($refund['expresssn'])}
                    <div class="form-group">
                        <div class="panel-heading" style="padding-left: 200px;">
                            <br>客户寄出快递信息
                        </div>
                    </div>


                    {if $refund['status']==3 || $refund['status']==4}
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">是否寄出快递 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static" style="color: #ef4f4f;">{if $refund['status']==3}等待客户寄出快递{else if $refund['status']==4}客户已经寄出快递{/if}</div>
                        </div>
                    </div>
                    {/if}

                    {if !empty($refund['expresscom'])}

                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">快递名称 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{$refund['expresscom']}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">快递单号 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{$refund['expresssn']} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button type='button' class='btn btn-default' onclick='refundexpress_find(this,"{$item['id']}",1)' >查看物流</button>
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">填写快递单号时间 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{php echo date('Y-m-d H:i:s',$refund['sendtime'])}</div>
                        </div>
                    </div>
                    {/if}

                    {/if}

                    {if !empty($refund['rexpresssn'])}
                    <div class="form-group">
                        <div class="panel-heading" style="padding-left: 200px;">
                            <br>店家寄出快递信息
                        </div>
                    </div>



                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">快递名称 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{if empty($refund['rexpresscom'])}其他快递{else}{$refund['rexpresscom']}{/if}</div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">快递单号 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{$refund['rexpresssn']} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button type='button' class='btn btn-default' onclick='refundexpress_find(this,"{$item['id']}",2)' >查看物流</button></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">确认发货时间 :</label>
                        <div class="col-sm-9 col-xs-12">
                            <div class="form-control-static">{php echo date('Y-m-d H:i:s',$refund['returntime'])}</div>
                        </div>
                    </div>
                    <div style="width:100%; height:60px;"></div>
                    {/if}

                </div>
            </div>
            {/if}
            <div class="panel panel-default">
                <div class="panel-heading">
                    商品信息</span>
                </div>
                <div class="panel-body table-responsive">
                    <table class="table table-hover">
                        <thead class="navbar-inner">
                        <tr>
                            <th style="width:8%;">ID</th>
                            <th style="width:16%;">商品标题</th>
                            <th style="width:22%;">商品规格</th>
                            <th style="width:10%;">商品编号</th>
                            <th style="width:16%;">现价/原价/成本价</th>
                            <th style="width:8%;">购买数量</th>
                            <th style="width:10%;color:red;">折扣前<br/>折扣后</th>
                            <th style="width:10%;">操作</th>
                        </tr>
                        </thead>
                        {loop $item['goods'] $goods}
                        <tr>
                            <td>{$goods['id']}</td>
                            <td>
                                {if $category[$goods['pcate']]['name']}
                                <span class="text-error">[{$category[$goods['pcate']]['name']}] </span>{/if}{if $children[$goods['pcate']][$goods['ccate']][1]}
                                <span class="text-info">[{$children[$goods['pcate']][$goods['ccate']][1]}] </span>
                                {/if}
                                {$goods['title']}
                            </td>
                            <td><span class="label label-info">{$goods['optionname']}</span></td>
                            <td>{$goods['goodssn']}{if $_GPC['plugin'] != 'fund'}<br/>{$goods['productsn']}{/if}</td>
                            <td>{$goods['marketprice']}元{if $_GPC['plugin'] != 'fund'}<br/>{$goods['productprice']}元 <br/>{$goods['costprice']}元{/if}</td>
                            <td>{$goods['total']}</td>
                            <td style='color:red;font-weight:bold;'>{$goods['orderprice']}<br/>{$goods['realprice']}
                                {if intval($goods['changeprice'])!=0}
                                <br/>(改价{if $goods['changeprice']>0}+{/if}{php echo number_format(abs($goods['changeprice']),2)})
                                {/if}
                            </td>
                            <td>
                                <a href="{php echo $this->createWebUrl('shop/goods', array('id' => $goods['id'], 'op' => 'post', 'plugin' => $_GPC['plugin']))}" class="btn btn-default btn-sm" title="编辑"><i class="fa fa-edit"></i></a>&nbsp;&nbsp;
                            </td>
                        </tr>
                        <tr style="text-align: right;padding: 6px 0;border-top:none;">
                            <td colspan="8">{if $goods['status']==1}<label data="1" class="label label-default text-default label-info text-pinfo">上架</label>{else}<label data="1" class="label label-default text-default label-info text-pinfo">下架</label>{/if}<label data="1" class="label label-default text-default label-info text-pinfo">{if $goods['type'] == 1}实体商品{else}虚拟商品{/if}</label></td>
                        </tr>
                        {/loop}
                        <tr>
                            <td colspan="2">

                                {template 'web/order/ops'}

                            </td>
                            <td colspan="8">
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script language="javascript">
        $("select[name=eexpress]").val("{$item['express']}");

        $("#eexpress").change(function () {
            var obj = $(this);
            var sel = obj.find("option:selected").attr("data-name");
            $("#eexpresscom").val(sel);
        });
        function showDiyInfo(obj){
            var hide = $(obj).attr('hide');
            if(hide=='1'){
                $(obj).next().slideDown();
            }
            else{
                $(obj).next().slideUp();
            }
            $(obj).attr('hide',hide=='1'?'0':'1');
        }

        {ifp 'order.op.changeaddress'}
        {if $trade['is_street'] == '1'}
        cascdeInit("{php echo isset($user['province'])?$user['province']:''}","{php echo isset($user['city'])?$user['city']:''}","{php echo isset($user['area'])?$user['area']:''}","{php echo isset($user['street'])?$user['street']:''}");
        {else}
        cascdeInit("{php echo isset($user['province'])?$user['province']:''}","{php echo isset($user['city'])?$user['city']:''}","{php echo isset($user['area'])?$user['area']:''}");
        {/if}
        $('#editaddress').click(function() {
            show_address(1);
        });

        $('#backaddress').click(function() {
            show_address(0);
        });

        $('#editexpress').click(function() {
            show_express(1);
        });

        $('#backexpress').click(function() {
            show_express(0);
        });

        $('#saveexpress').click(function() {
            var url = "{php echo $this->createWebUrl('order/list',array('op'=>'saveexpress'))}";
            var id ={php echo $id};

            var express = $('#eexpress').val();
            var expresscom = $('#eexpresscom').val();
            var expresssn = $('#eexpresssn').val();

            if(expresssn==''){
                alert('请填写快递单号!');
                return false;
            }

            $.ajax({
                url: url,
                dataType: "json",
                data: {id:id,express:express,expresscom:expresscom,expresssn:expresssn},
                success:function(json){
                    var result = json.result;
                    if(json.status==1){
                        location.reload();
                    } else {
                        alert(result);
                    }
                }
            });
        });

        $('#saveaddress').click(function() {
            var url = "{php echo $this->createWebUrl('order/list',array('op'=>'saveaddress'))}";
            var id ={php echo $id};
            var realname = $('#realname').val();
            var mobile = $('#mobile').val();
            var province = $('#sel-provance').val();
            var city = $('#sel-city').val();
            var area = $('#sel-area').val();
            var address = $('#address_info').val();
            var street = '';

            if(realname==''){
                alert('请填写收件人姓名!');
                return false;
            }

            if(mobile==''){
                alert('请填写收件人手机!');
                return false;
            }

            if(province=='请选择省份'){
                alert('请选择省份!');
                return false;
            }
            {if $trade['is_street'] == 1}
                street = $('#sel-street').val();
            {/if}

            if(address==''){
                alert('请填写详细地址!');
                return false;
            }
            $.ajax({
                url: url,
                dataType: "json",
                data: {id:id,realname:realname,mobile:mobile,province:province,city:city,area:area,street:street,address:address},
                success:function(json){
                    var result = json.result;
                    if(json.status==1){
                        location.reload();
                    } else {
                        alert(result);
                    }
                }
            });
        });

        function show_address(flag) {
            if (flag == 1) {
                $('.ad1').hide();
                $('.ad2').show();
            } else {
                $('.ad1').show();
                $('.ad2').hide();
            }
        }
        function show_express(flag) {
            if (flag == 1) {
                $('.ex1').hide();
                $('.ex2').show();
            } else {
                $('.ex1').show();
                $('.ex2').hide();
            }
        }
        {/if}

    </script>
    {template 'web/order/modals'}
    {if  p('commission')}

    {template 'commission/changecommission'}
    {/if}

    {template 'web/_footer'}

