<link rel="stylesheet" type="text/css" href="../addons/sz_yi/plugin/coupon/template/mobile/default/images/style.css">
<style type="text/css">
	#coupon_chooser_layer {height: 100%; width: 100%; background: rgba(0,0,0,0.6); position: fixed; top: 0px; left: 0px; z-index: 9;display:none }
         #coupon_chooser {height:auto; width:100%;padding-bottom:45px; background:#eee; position:fixed; bottom:0px; left:0px; z-index:10;display:none}

	 
	.coupon_list { width:100%;overflow:auto; overflow-x:hidden;}
	.coupon_get { margin:10px 30px;border:1px solid #ff6600; color:#ff6600; background:#fff; border-radius: 3px; text-align: center;padding:5px 0;font-size:13px;} 
	.coupon_no {height:100px;  margin:50px 0px 60px; color:#bbb; font-size:12px; text-align:center;}
         .coupon_no_menu {height:40px; width:100%;}
         .coupon_no_nav {height:38px; width:43%; background:#eee; margin:0px 3%; float:left; border:1px solid #d4d4d4; border-radius:5px; text-align:center; line-height:38px; color:#666;}
	.coupon_footer { position: absolute;; bottom:0px; height:45px;width:100%;}
	.coupon_footer .coupon_btn { float:left;height:45px;line-height:45px; font-size:14px; text-align: center; color:#fff;}
	.coupon_footer .coupon_cancel { background:#ccc; width:40%; }
	.coupon_footer .coupon_confirm { background:#f60; width:60%; }
	
	
</style>
<div id='coupon_container'></div>
<script id='tpl_coupons' type='text/html'>
	<div id="coupon_chooser_layer"></div>
	<div id="coupon_chooser">
		<div class="coupon_list">
		<%each cards as coupon%>
		 <div class="coupon_item"
			   data-couponname="<%coupon.couponname%>"
			 data-couponid="<%coupon.id%>"
			 data-deduct="<%coupon.deduct%>"
			 data-discount="<%coupon.discount%>"
			 data-backtype="<%coupon.backtype%>"
			  >
          <div class='bg cside side side-left'></div>

	<div class="cinfo" >
		<div class="inner" >
			<div class="name"><%coupon.balance%></div>
			<div class="time">
			<%coupon.timestr%></div>
		</div>
	</div>
</div>
		<%/each%>
		   
		</div>

		<div class="coupon_footer">
			<div class="coupon_btn coupon_cancel">不使用优惠券</div>
			<div class="coupon_btn coupon_confirm">确定使用</div>
		</div>
	</div>
</script>
<script language="javascript">
	var CardChooser = {};
	require(['core','tpl'],function(core,tpl){
		CardChooser.close = function(){
			$('#coupon_chooser_layer').hide();
			$('#coupon_chooser').hide();
		}
		CardChooser.open = function(result){
		   var html = tpl('tpl_coupons',result);
		   $('#coupon_container').html(html);
                      var h = $(document.body).height() * 0.7;
		   $('#coupon_chooser').css('max-height',h).fadeIn(300);
                      $('.coupon_list').css('max-height',h);
		   $('#coupon_chooser_layer').fadeIn(300).unbind('click').click(function(){
			   CardChooser.close();
		   });
		
		   var couponid = $("input[data-name='couponid'][data-id="+result.supplier_uid+"]").val();
		  
		    if( couponid== '' ) {
				couponid='0';
		    }
		 
		  $('#coupon_chooser .coupon_item').removeClass('coupon_selected');
		  $('#coupon_chooser .coupon_item[data-couponid=' +couponid +']' ).addClass('coupon_selected');

			   
		   $('#coupon_chooser .coupon_item').unbind('click').click(function(){
			   $('#coupon_chooser .coupon_item').removeClass('coupon_selected');
			   $(this).addClass('coupon_selected');
			   $("input[data-name='couponid'][data-id="+result.supplier_uid+"]").val($(this).data('couponid'));
			   $('.couponselect[data-id='+result.supplier_uid+']').data({
				'couponname': $(this).data('couponname'),
				'couponid':$(this).data('couponid'),
			          'deduct':$(this).data('deduct'),
			          'discount':$(this).data('discount'),
				 'backtype':$(this).data('backtype')
			   }).html("我选择了 " +$(this).data('couponname'));
			  
		   });
		   $('#coupon_chooser .coupon_cancel').unbind('click').click(function(){
			   $("input[data-name='couponid'][data-id="+result.supplier_uid+"]").val('');
			   $('.couponselect[data-id='+result.supplier_uid+']').html('我要使用优惠券');
			   $('#coupon_chooser .coupon_item').removeClass('coupon_selected');
			   CardChooser.close();
			   if(CardChooser.cancelCallback){
				   CardChooser.cancelCallback();
			   }
		   });
		   $('#coupon_chooser .coupon_confirm').unbind('click').click(function(){
			    if($("input[data-name='couponid'][data-id="+result.supplier_uid+"]").val()=='' || $("input[data-name='couponid'][data-id="+result.supplier_uid+"]").val()=='0'){
				    core.tip.show('请选择优惠券!');
				    return;
			    }
				var r = false;
			   	$.each(result.supplier_uids,function(b){
			   		
			   		
			   		if ($("input[data-name='couponid'][data-id="+result.supplier_uid+"]").val() == $("input[data-name='couponid'][data-id="+b+"]").val() && b != result.supplier_uid) {
			   			r = true;
			   			return;
			   		}
			   	})
			   	if (r) {
		   			core.tip.show('此优惠券已经被选中，请选择其他优惠券！');
		   			return;
			   	}
			   
			   	$('#coupon_chooser .coupon_item').removeClass('coupon_selected');

			   CardChooser.close();
			   if(CardChooser.confirmCallback){
				   CardChooser.confirmCallback();
			   }
		   		
		   	
		   			
			   	

			    
			   
		   });
		   
		 
    	      }
	});
	
	
</script>
