{template 'common/header'}
<title>购物车</title>
{template 'common/navigation'}
<!--  -->
<form name="formone">
<div class="w m0a">
	<div class="cart-main cart-main-new">
		<div class="cart-thead">
			<div class="column t-checkbox">
				<div class="cart-checkbox">
					<input class="jdcheckbox" type="checkbox" checked="checked" id="checkall" name="subcheckbox">
				</div>
				全选 </div>
			<div class="column t-goods">
				商品</div>
			<div class="column t-props">
&nbsp;</div>
			<div class="column t-price">
				单价(元)</div>
			<div class="column t-quantity">
				数量</div>
			<div class="column t-sum">
				小计(元)</div>
			<div class="column t-action">
				操作</div>
		</div>
		<div class="cart-item-list">
			<div class="shop">
				<div class="cart-checkbox">
					<input class="all jdcheckbox" type="hidden" /> </div>
				<span class="shop-txt">
				<a class="shop-name self-shop-name" href="#">芸众商城</a> </span>
			</div>
			
			<div class="item-list">
				<div class="item-full minus-item">


					{loop $list $good}
					<!-- list begin -->
					<div class=" item-last item-item cart_good" 
							data-cartid="{$good['id']}"
							sel='1'
							data-marketprice="{$good['marketprice']}"
							data-goodsid="{$good['goodsid']}"
                        	data-maxbuy='{$good['maxbuy']}' 
                        	data-stock='{$good['stock']}'
							>


						<div class="item-form">
							<div class="cell p-checkbox">
								<div class="cart-checkbox">
	 							 <input  type="checkbox"  class="jdcheckbox check" checked="checked" name="subcheckbox">					
								</div>
							</div>
							<div class="cell p-goods">
								<div class="goods-item">
									<div class="p-img">
										<a href="#"><img src="{php echo $good['thumb']}"></a>
									</div>
									<div class="item-msg">
										<div class="p-name"><a href="{php echo $this->createMobileUrl('shop/detail',array('id' => $good['goodsid']))}">{php echo $good['title']}</a></div>
									</div>
								</div>
							</div>
							<div class="cell p-props p-props-new">
								<div class="props-txt">颜色：红色</div>
							</div>
							<div class="cell p-price"><strong>{php echo $good['marketprice']}</strong></div>
							<div class="cell p-quantity">
								<div class="quantity-form" data-maxbuy="{$good['maxbuy']}" data-stock="{$good['stock']}">
									<div class="decrement">-</div>
									<input type="text" class="itxt" value="{$good[total]}">
									<div class="increment">+</div>
								</div>
								
							</div>
							<div class="cell p-sum"><strong id="{$good['id']}">{php echo $good[total] * $good['marketprice']}</strong></div>
							<div class="cell p-ops">
								<a  class="cart-remove" href="javascript::void(del)" data-delid = '{$good['id']}'>删除</a>
								<!-- {php echo $this->createMobileUrl('shop/cart',array('op' => 'remove'))}&id={$good['id']} -->
								<a href="#" class="cart-follow">移到我的收藏</a>
							</div>						
						</div>
					</div>
					<!-- list end -->
					{/loop}

				</div>
			</div>

		</div>

		<!-- 结算 -->
		<div class="cart-toolbar">
			<div class="options-box">
				<!-- <div class="select-all">
					<div class="cart-checkbox">
						<input type="checkbox" class="selected jdcheckbox" id="selected" name="invest" value="checkbox">
					</div>反选
				</div> -->
				<div class="operation">
					<a href="javascript::void(delcheck)" class="remove-batch fl">删除选中的商品</a>
					<a href="#" class="remove-batch fl">移动到我的收藏</a>
				</div>
				<div class="toolbar-right">
					<div class="comm-right">
						<div class="btn-area paysub"><a href="javascript::void(0)" class="submit-btn">去结算<span id = 'totaltwo'></span></a></div>
						<div class="price-sum">
							<div>
								<span class="txt">品总价（含运费）：</span>
								<span class="price sumPrice"><em id="totalprice"></em></span>
								<br>
								<span class="txt">共<em id="total"></em>件商品</span>
								<span class="price totalRePrice"></span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</form>
<script type="text/javascript">

//结算触发
	$(document).ready(function(){
		$('.paysub').click(function(){
            var ids = [];
            $('.cart_good[sel=1]').each(function(){
                ids.push($(this).data('cartid'));
	        });
	        if(ids.length <=0){
	        	alert('未选择商品');
	        	return;
	        }
	        location.href = '{php echo $this->createMobileUrl("order/confirm");}&cartids='+ids.join(',');//core.getUrl('order/confirm',{cartids:ids.join(',')});
    	});

//删除触发
		$('.cart-remove').click(function(){
			var $this = $(this);
			var ids = [];
			var delid = $this.attr('data-delid');
			ids.push(delid) ;
			//alert(delid);
			var del = confirm("确定删除这件商品吗？删除将不能恢复！");
			if(del == true){
				$.post('{php echo $this->createMobileUrl("shop/cart")}',
				{
					op: "remove",
					ids: ids
				},
				function(json){
					if(json.status==1)  {
                        //alert(1);
                        $('.item-last[data-cartid=' + delid+ ']').attr('sel',0).fadeOut(500,function(){
                        	$(this).remove();
                        });
                        calcprice();
                    }
                    else{
                        alert('删除失败');
                    }
				},
				'json');
			}
		});

//删除选中触发
		$('.remove-batch').click(function(){
			var ids =[];
            $('.item-last[sel=1]').each(function(){
                ids.push($(this).data('cartid')) ;
            })
            if(ids.length<=0){
                alert('未选择商品');
                return;
            }
            var delcheck = confirm("确认删除选中商品吗？删除将不能恢复！");
            if(delcheck == true){
            	//alert(ids);
            	$.post('{php echo $this->createMobileUrl("shop/cart")}',
				{
					op:"remove",
					ids:ids
				},
            	function(json){
            		if (json.status==1) {
            			console.log('ids:'+ids);
                        for(var i in ids){
                        	if($.isNumeric(i) == false){
                        		continue;
                        	}
                        	console.log('ID:'+i);
                            $('.item-last[data-cartid=' + ids[i]+ ']').attr('sel',0).fadeOut(500,function(){
                            	$(this).remove();
                            	//console.log("test:"+i);
                            }) 
                        }
                    	if($('.item-last[sel=1]').length<=0){
                             calcprice();
                        }
            		}else {
            			alert("删除失败");
            		}
            	},'json');
            }
		});

//计算金额数量总和
	    function calcprice(){
	    	var total = 0;
	    	var totalprice = 0;
	    	$(".item-last").each(function(){
	    		var $this = $(this);
	    		var sel = $this.attr('sel') == '1';
	    		//alert(sel);
	    		var check= $this.find(".check").is(':checked');
	    		//alert(gouxuan);
	    		if(sel && check){
	    			var num = $this.find(".itxt").val();
	    			if(isNaN(num)){
	    				num = 1;
	    		}
	    		total+=parseInt(num);
	    		totalprice+=parseFloat($this.find('.itxt').val()) * parseFloat($this.attr('data-marketprice'));
	    		}
	    		var number=document.getElementById("total");
	    		number.innerHTML=total;
	    		var numbertwo=document.getElementById("totaltwo");
	    		numbertwo.innerHTML='(' + total + ')';
	    		var quantity=document.getElementById("totalprice");
	    		quantity.innerHTML="￥" + totalprice;
	    	});
	    }
	    
//点击全选触发事件
	    $("#checkall").click(function() {
            $('input[name="subcheckbox"]').attr("checked",this.checked);
            $('.item-last').each(function(){
            	$this = $(this);
            	var check = $('input[name="subcheckbox"]').is(':checked');
	        	var sel = (check) ? 1 : 0;
            	$this.attr('sel',sel);
            })
            calcprice();
	    });

	    var $subcheckbox = $("input[name='subcheckbox']");
	    $subcheckbox.click(function(){
	        $("#checkall").attr("checked",$subcheckbox.length == $("input[name='subcheckbox']:checked").length ? true : false);
	        var check = $(this).is(':checked');
	        var sel = (check) ? 1 : 0;
	        $(this).closest('.cart_good').attr('sel', sel);
	        calcprice();
        });

//商品数量减少事件
		$(".decrement").click(function(){
            var input =$(this).next();
            var num = parseFloat( input.val() );
            num--;
            if(num <= 0){
                num=1;
            }
            input.val(num);
			//alert(input.val());
			//alert(num);
			var single = $(this).parent().parent().parent().parent().attr('data-marketprice');
			var cartid = $(this).parent().parent().parent().parent().attr('data-cartid');
			single = input.val() * single;
			var singlemon=document.getElementById(cartid);
	    	singlemon.innerHTML="￥" + single;

			calcprice();
		});

//商品数量增加事件
		$(".increment").click(function(){
			var maxbuy = $(this).parent().attr('data-maxbuy');
			var stock = $(this).parent().attr('data-stock');
			//alert(stock);
			var input =$(this).prev();
            var num = parseFloat( input.val() );
            num++;
            if(num >= maxbuy && maxbuy > 0){
                num = maxbuy;
                alert("您最多购买 " + maxbuy + "件");
            } else if(stock!='-1' && stock!='' && num>stock){
            	num=stock;
            	alert("您最多购买 " + stock + "件");
            }
            input.val(num);
            var single = $(this).parent().parent().parent().parent().attr('data-marketprice');
			var cartid = $(this).parent().parent().parent().parent().attr('data-cartid');
			single = input.val() * single;
			var singlemon=document.getElementById(cartid);
	    	singlemon.innerHTML="￥" + single;
            calcprice();
		});

		calcprice();
	})
</script>
<!-- foot -->
<div class="cover-page-foot fl wfs">
<p class="subnav">
<a target="_blank" href="http://about.ecmoban.com/company.php#contact">联系我们</a>
<a target="_blank" href="http://about.ecmoban.com/company.php">公司简介</a>
<a target="_blank" href="http://about.ecmoban.com/payment.php">支付方式</a>
<a target="_blank" href="http://about.ecmoban.com/legal.php">法律条款</a>
<a target="_blank" href="http://www.ecmoban.com/daili.php">合作代理</a>
<a target="_blank" href="http://about.ecmoban.com/friendlink.php">友情链接</a>
<a target="_blank" href="http://about.ecmoban.com/hr.php">诚聘英才</a>
<a class="last" target="_blank" href="http://www.ecmoban.com/topic/feature_list/index.html">服务支持</a>
</p>
<p class="copyright">© 2005-2016 ecshop模板堂(ecmoban.com) 版权所有，并保留所有权利。常年法律顾问:<a class="copyright" target="_blank" href="http://about.ecmoban.com/article-1557.html">上海华宏律师事务所</a></p>
<p class="address">上海市普陀区中山北路3553号伸大厦3层</p>
<div style="background-color:#E1E1E1; text-align:center; height:20px;padding-top:5px;">
<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010702001054" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="http://www.ecmoban.com/content/themes/ecmoban2014/images/beian_ghs.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">沪公网安备 31010702001054号</p></a>
<div>
</div>
<!--  -->

</body>

</html>
