{template 'common/header'}
<title>{$yunbi_title}记录</title>
<style type="text/css">
    body {margin:0px; background:#f9f9f9; -moz-appearance:none;font: 12px/1.5 tahoma, "microsoft yahei", "\5FAE\8F6F\96C5\9ED1";}
    a {text-decoration:none;}
    .header {height: auto;padding:0px; background:#f15353;background-size: 100% 100%; padding:10px;position: relative;}
    .header .user {height:100px;text-align: center;}
    .header .user .user-head {height:48px; width:48px; background:#fff; border-radius:50%; border:2px solid #fff;margin: 6px auto;}
    .header .user .user-head img {height:48px; width:48px; border-radius:50%;}
    .header .user .user-info {height:48px; width:100%; float:left;color:#fff;}
    .header .user .user-info .user-name {height:20px; width:auto; font-size:14px; line-height:20px;}
    .header .user .user-info .user-other {height:24px; width:auto; font-size:12px;}
    .header .user .set {position: absolute;right: 10px;top: 10px;color: #fff;font-size: 14px}

    .credit_list {height:auto; width:94%; background:#fff; padding:10px 3%;margin-top:5px;overflow: hidden;}
    
    .credit_list .info {max-height:80px; width:57% !important; float:left;  font-size:16px; color:#666; line-height:20px; text-align:left;    border-right: 1px solid #eaeaea;}
    .credit_list .info p {font-size:14px; color:#545454;max-height: 40px;overflow: hidden;margin: 0;}
    .credit_list .info span {font-size:14px; color:#999;}
    .credit_list .num {max-height:60px; width:42%;line-height:20px; float:right; text-align:center; font-size:16px; color:#666;}
    .credit_list .num span {font-size:14px; color:#999;}

    .credit_tab {height:30px; margin:5px; border:1px solid #f15353; border-radius:5px; overflow:hidden;font-size:13px;background:#fff;padding-right: -2px;}
    .credit_nav {height:30px; width:25%;  background:#fff; color:#666; text-align:center; line-height:30px; float:left;}
    .credit_nav1 {height: 42px;
    width: 50%;
    background: #fff;
    color: #666;
    text-align: center;
    line-height: 44px;
    float: left;}
    .yunb-nav {color:#fff; background:#f15353;}

    .credit_no {height:100px; width:100%; margin:50px 0px 60px; color:#ccc; font-size:12px; text-align:center;}
    #credit_loading { padding:10px;color:#666;text-align: center;}

    .cart {height:auto; width:100%; background:#fff; margin-top:10px; border-bottom:1px solid #e3e3e3;}
    .new-ullist ul li {height:auto; width:33%; }
    .new-ullist ul li i {
        border-radius: 10px;
        color: #fff;
        font-size: 20px;
        height: 48px;
        line-height: 48px;
        margin-bottom: 4px;
        width: 48px;
    }
    .copyright {height:40px; width:100%; text-align:center; line-height:40px; font-size:12px; color:#999; margin-top:10px;}
    span.count {float:right; margin-top:16px; margin-right: 4px; height:14px; background:#f30; border-radius:8px; font-size:12px; color:#fff; line-height:14px; text-align: center;padding: 0 5px}

    .position {position: fixed;top: -10px;color: #fff;font-size: 14px;z-index: 99;}

.order {height:70px; width:100%; background:#fff; border-bottom:1px solid #e3e3e3;}
    .order_all {height:100px; width:100%; padding:14px 0px; color:#666;}
.order_all a i{font-size:20px;margin-bottom: 4px}
    .order_pub {height:auto; float:left; border-left:1px solid #eee; padding-top:2px; text-align:center; color:#8c8c8c; position:relative;font-size: 14px}
    .order_pub span {height:14px; background:#f30; border-radius:8px; position:absolute; top:0; right:6%;padding: 0 5px;font-size:12px; color:#fff; line-height:14px;}
    .order_1 {width:24%;}
    .order_2 {width:25%;}
    .order_3 {width:25%;}
    .order_4 {width:25%;}
    .list1 {height:44px; width:97%; background:#fff; padding:0 0 0 3%; margin-top:10px; border-top:1px solid #e3e3e3;font-size: 16px;line-height:44px; color:#242424;}
    .list1 i {font-size:16px; margin-right:6px;color: #929292;width: 20px;height: 20px;text-align: center;}
    .allorder {float:right; color:#909090; margin-right:10px; text-decoration:none;font-size: 12px}
</style>
    <div class="header">
        <div class="user">
            <div class="user-head"><img src="{$member['avatar']}" /></div>
            <div class="user-info">
                <div class="user-name">{$member['nickname']}[会员ID:{$member['id']}]</div>
                <div class="user-other" {if !empty($set['shop']['levelurl'])}onclick='location.href="{$set['shop']['levelurl']}"'{/if}>[{$level['levelname']}] {if !empty($set['shop']['levelurl'])}<i class='fa fa-question-circle' ></i>{/if}
                    {if $shop_set['shop.isreferrer']}
                        [推荐人：{$referrer['realname']}]
                    {/if}
                </div>
            </div>
            <div class="set" onclick='location.href="{php echo $this->createMobileUrl('member/info')}"'><i class="iconfont icon-cog"></i></div>
        </div>
    </div>

    <div class="money-center">
        <div class="list1" style="margin-top:0px;border-bottom: 1px solid #ECECEC;">
        <i class="iconfont icon-virtual" style="float:left; line-height:44px;"></i>
        <span style="float:left;">{$yunbi_title}交易中心</span>
        <div class="allorder">
        {if $member['virtual_currency'] >= 500 && p('yunbi')}
            <a href="#" class="recharge-ybut" onclick="location.href='{php echo $this->createPluginMobileUrl('yunbi/yunbi_trading',array('op'=>'trading'))}'">出让{$yunbi_title}</a>
        {/if}
        {if !empty($yunbiset['isbot'])}
            {if $member['virtual_currency'] > 0 && p('yunbi')}
                <a href="#" class="recharge-ybut" onclick="location.href='{php echo $this->createMobileUrl('member/transfer',array('openid'=>$openid,'op'=>'transfer', 'yunbi' => 1))}'">{if !empty($yunbi_title)}{php echo $yunbi_title}{else}云币{/if}转账</a>
            {/if}
        {/if}
        </div>
        </div>
        <div class="order">
            <div class="order_all">
                <a href="#"><div class="order_pub order_1" data-type='1' style="border:0px;"><i class="fa"></i><br>全部交易<span>{$trading_1}</span></div></a>
                <a href="#"><div class="order_pub order_3" data-type='3'><i class="fa"></i><br>交易中<span><span>{$trading_3}</span></div></a>
                <a href="#"><div class="order_pub order_2" data-type='2'><i class="fa"></i><br>我的交易<span><span>{$trading_2}</span></div></a>
                <a href="#"><div class="order_pub order_4" data-type='4'><i class="fa"></i><br>已完成<span><span>{$trading_4}</span></div></a>
            </div>
        </div>
    </div>

    <div id="container"> </div>
    <script id='tpl_log' type='text/html'>
            <%each list as log%>
                <div class="credit_list">
                    <div class="info">
                        <p>{$yunbi_title}：
                            <%log.money%>
                            
                            <%if log.status == '0'%>
                                <span style="color:rgb(9, 176, 46);">
                                    交易中
                                </span>
                            <%else%>
                                <span style="color:red;">
                                    已完成
                                </span>
                            <%/if%>
                            
                        </p>
                        <span style="height: 44px;line-height: 44px;">时间：<%log.create_time%></span>
                    </div>
                    <div class="num">
                        <span>
                            <%log.remark%></br>
                            <span style="height: 44px;line-height: 44px;">￥：<%log.price%></span>
                            <%if log.status_text%><%log.status_text%><%/if%>
                            <%if log.iscancel == '1'%>
                                <a href="#" class="recharge-ybut cancel" data-id='<%log.id%>'>撤回</a>
                            <%/if%>
                            <%if log.istrading == '1'%>
                                <a href="<%log.buy_link%>" onclick="if(!confirm('是否确认购买!')){return false;}" class="recharge-ybut">购买</a>
                            <%/if%>
                        </span>
                    </div>
                </div>
            <%/each%>
    </script>
    <script id='tpl_empty' type='text/html'>
        <div class="credit_no"><i class="fa fa-file-text-o" style="font-size:100px;"></i><br><span style="line-height:18px; font-size:16px;">暂时没有任何记录~</span></div>
    </script>


<div class="copyright">版权所有 ©{if empty($set['shop']['copyright'])}{$set['shop']['name']}{else}{$set['shop']['copyright']}{/if} </div>

<script language="javascript">
    var page = 1;
    var scrolled = false;
    var type = "{php echo intval($_GPC['type'])}";
    require(['tpl', 'core'], function (tpl, core) {

        $(document).on('click','.cancel',function () {
             if(!confirm("是否确认撤回！")){
                return;
             }
            var id = $(this).data('id');
            core.pjson('yunbi/yunbi_trading', {id:id,op:'cancel'}, function (json) { 
                if(json.status!=1){
                    core.tip.show(json.result);
                    return;
                }
                core.message('出让已撤回!',"{php echo $this->createPluginMobileUrl('yunbi/yunbi_trading')}",'success');
            }, true);
            
        });

        $('.order_pub').unbind('click').click(function () {
            page = 1;
            type = $(this).data('type');
            getLog(type);
        });
        function bindScroller(){
            var loaded = false;
            var stop = true;
            $(window).scroll(function () {
                if (loaded) {
                    return;
                }
                totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
                if ($(document).height() <= totalheight) {
                    if (stop == true) {
                        stop = false; scrolled = true;
                        $('#container').append('<div id="credit_loading"><i class="fa fa-spinner fa-spin"></i> 正在加载...</div>');
                        page++;
                        core.pjson('yunbi/yunbi_trading', {type:type,page:page,op:'log'}, function (json) {
                            stop = true;
                            $('#credit_loading').remove();
                            $("#container").append(tpl('tpl_log', json.result));
                            if (json.result.list.length < json.result.pagesize) {
                                $('#credit_loading').remove();
                                $("#container").append('<div id="credit_loading">已经加载完全部记录</div>');
                                loaded = true;
                                $(window).scroll = null;
                                return;
                            }
                        }, true);
                    }
                }
            });
        }
        function getLog(type) {
            core.pjson('yunbi/yunbi_trading', {type:type,page: page,op:'log'}, function (json) { 
                $('.order_pub').removeClass('yunb-nav');
                $('.order_pub[data-type=' + type + ']').addClass('yunb-nav'); 
                if (json.result.list.length <= 0) {
                    $('#container').html(tpl('tpl_empty'));
                    return;
                }
                $('#container').html(tpl('tpl_log', json.result));
                bindScroller();
            }, true);
        }
        getLog(type);
    });
</script>


{php $show_footer=true}
{template 'common/footer'}